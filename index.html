<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¨×•×œ×˜×” ××•×œ×˜×™××˜×™×‘×™×ª - ×”×›×œ ×›×œ×•×œ</title>
    <style>
        :root {
            --wheel-size: 300px;
            --wheel-border: 12px;
            --plate-color: #222;
            --gold: #f1c40f;
            --felt-color: #1e8449;
            --red-color: #c0392b;
            --black-color: #2c3e50;
            --green-color: #27ae60;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #121212;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding-bottom: 60px;
            user-select: none;
            overflow-x: hidden;
        }

        h1 {
            color: var(--gold);
            text-shadow: 0 0 15px rgba(241, 196, 15, 0.6);
            margin: 15px 0;
            font-size: 2rem;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* --- Canvas --- */
        #confetti-canvas {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none; z-index: 100;
        }

        /* --- Layout Containers --- */
        .main-layout {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-start;
            gap: 20px;
            width: 100%;
            max-width: 1200px;
        }

        .left-panel { flex: 1; min-width: 200px; display: flex; flex-direction: column; gap: 10px; }
        .center-panel { flex: 2; display: flex; flex-direction: column; align-items: center; }
        
        /* --- Dashboard --- */
        .dashboard {
            display: flex; gap: 10px; margin-bottom: 10px;
            width: 95%; max-width: 800px; justify-content: space-between;
            background: #1f1f1f; padding: 12px; border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); border: 1px solid #333;
        }

        .stat-box {
            flex: 1; text-align: center;
            background: rgba(0,0,0,0.3); padding: 5px; border-radius: 8px;
        }
        .stat-label { font-size: 0.75rem; color: #888; margin-bottom: 2px; }
        .stat-value { font-size: 1.1rem; font-weight: bold; direction: ltr; }
        .val-balance { color: var(--gold); }
        .val-won { color: #2ecc71; }
        .val-lost { color: #e74c3c; }

        /* --- Hot & Cold Stats --- */
        .stats-card {
            background: #1f1f1f; border-radius: 10px; padding: 15px;
            border: 1px solid #333; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            width: 90%; margin: 0 auto;
        }
        .stats-title { font-size: 1rem; color: #aaa; margin-bottom: 10px; text-align: center; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .hot-row, .cold-row { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 8px; }
        .stat-icon { font-size: 1.2rem; }
        .stat-num-circle {
            width: 28px; height: 28px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 0.8rem; border: 1px solid rgba(255,255,255,0.2);
        }

        /* --- Wheel --- */
        .game-container {
            position: relative;
            width: var(--wheel-size); height: var(--wheel-size);
            border-radius: 50%; border: var(--wheel-border) solid #4a2c2c;
            background: var(--plate-color);
            margin: 0 auto 20px auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.7);
        }
        .wheel {
            width: 100%; height: 100%; border-radius: 50%; position: relative;
            transition: transform 4s cubic-bezier(0.15, 0.70, 0.10, 1.0); overflow: hidden;
        }
        .ball-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 50%; pointer-events: none; z-index: 5;
            transition: transform 4s cubic-bezier(0.15, 0.70, 0.10, 1.0);
        }
        .ball {
            position: absolute; top: 25px; left: 50%; width: 14px; height: 14px;
            background: radial-gradient(circle at 30% 30%, #fff, #bbb);
            border-radius: 50%; transform: translateX(-50%); box-shadow: 0 0 5px white;
        }
        .marker {
            position: absolute; top: -18px; left: 50%; transform: translateX(-50%);
            width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent;
            border-top: 22px solid var(--gold); z-index: 20; filter: drop-shadow(0 2px 2px black);
        }
        .center-hub {
            position: absolute; top: 50%; left: 50%; width: 45px; height: 45px;
            background: radial-gradient(circle at 30% 30%, var(--gold), #b8860b);
            border-radius: 50%; transform: translate(-50%, -50%); z-index: 10;
            box-shadow: 0 0 10px black;
        }

        /* --- History Bar --- */
        .history-bar {
            display: flex; gap: 5px; height: 45px; background: rgba(0,0,0,0.5);
            padding: 0 15px; border-radius: 25px; margin-bottom: 15px;
            align-items: center; justify-content: center; border: 1px solid #444;
            min-width: 300px;
        }
        .hist-bubble {
            width: 32px; height: 32px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 0.85rem; border: 2px solid rgba(255,255,255,0.1);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        /* --- Controls & Chips --- */
        .actions-row {
            display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-bottom: 15px; width: 100%;
        }
        
        .chip-selector {
            display: flex; gap: 8px; background: #222; padding: 8px 15px; border-radius: 50px; border: 1px solid #444;
        }
        .chip-btn {
            width: 42px; height: 42px; border-radius: 50%; border: 3px dashed rgba(255,255,255,0.7);
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 0.8rem; color: #000; cursor: pointer;
            transition: transform 0.2s; position: relative;
        }
        .chip-btn:hover { transform: translateY(-3px); }
        .chip-btn.active { transform: scale(1.15); border-style: solid; box-shadow: 0 0 10px white; z-index: 2; }
        
        .chip-0-5 { background: radial-gradient(#3498db, #2980b9); color: white; }
        .chip-1 { background: radial-gradient(#ecf0f1, #bdc3c7); }
        .chip-2-5 { background: radial-gradient(#9b59b6, #8e44ad); color: white; }
        .chip-5 { background: radial-gradient(#e74c3c, #c0392b); color: white; }
        .chip-10 { background: radial-gradient(#34495e, #2c3e50); color: white; border-color: var(--gold); }

        .pro-controls { display: flex; gap: 5px; }
        .pro-btn {
            background: #333; color: white; border: 1px solid #555; border-radius: 6px;
            padding: 5px 12px; font-size: 0.8rem; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-width: 55px; height: 50px; transition: 0.2s;
        }
        .pro-btn:hover { background: #444; }
        .pro-btn:active { transform: scale(0.95); }
        .pro-btn span { font-size: 1.2rem; }

        /* --- Table --- */
        .table-wrapper { overflow-x: auto; width: 98%; max-width: 850px; padding: 5px; }
        .betting-table {
            display: grid;
            grid-template-columns: 50px repeat(12, 1fr) 40px; 
            grid-template-rows: repeat(3, 50px) 45px 45px;
            gap: 3px; background-color: var(--felt-color);
            border: 10px solid #5d4037; border-radius: 8px; padding: 10px;
            min-width: 650px; direction: ltr;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
        }

        .b-cell {
            display: flex; align-items: center; justify-content: center;
            border: 1px solid rgba(255,255,255,0.15);
            font-weight: bold; color: white; cursor: pointer; position: relative; font-size: 14px;
            transition: background 0.1s;
        }
        .b-cell:hover { background-color: rgba(255,255,255,0.1); }
        .b-cell:active { transform: scale(0.96); }

        .bg-red { background-color: var(--red-color); }
        .bg-black { background-color: var(--black-color); }
        .bg-green { background-color: var(--green-color); }
        .bg-none { background-color: transparent; border: 1px solid rgba(255,255,255,0.3); }

        /* Grid Placement */
        .cell-zero { grid-column: 1; grid-row: 1 / span 3; border-radius: 4px 0 0 4px; font-size: 1.2rem; }
        .col-bet { grid-column: 14; writing-mode: vertical-rl; transform: rotate(180deg); font-size: 11px; }
        .dozen-bet { grid-row: 4; font-size: 12px; }
        .dozen-1 { grid-column: 2 / span 4; } .dozen-2 { grid-column: 6 / span 4; } .dozen-3 { grid-column: 10 / span 4; }
        .outside-bet { grid-row: 5; font-size: 12px; text-transform: uppercase; }
        .ob-1-18 { grid-column: 2 / span 2; } .ob-even { grid-column: 4 / span 2; } .ob-red { grid-column: 6 / span 2; background: var(--red-color); }
        .ob-black { grid-column: 8 / span 2; background: var(--black-color); } .ob-odd { grid-column: 10 / span 2; } .ob-19-36 { grid-column: 12 / span 2; }

        /* --- 3D Chip on Board --- */
        .chip-on-board {
            position: absolute; width: 26px; height: 26px;
            background: radial-gradient(circle at 30% 30%, #f1c40f, #f39c12);
            border: 2px dashed white; border-radius: 50%;
            color: black; font-size: 9px; display: flex; align-items: center; justify-content: center;
            font-weight: bold; pointer-events: none; z-index: 5;
            box-shadow: 0 3px 5px rgba(0,0,0,0.5), inset 0 0 5px rgba(255,255,255,0.5);
            animation: dropChip 0.2s ease-out;
        }
        @keyframes dropChip { from { transform: scale(1.5) translateY(-20px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }

        /* --- Messages & Modals --- */
        .message { margin-top: 15px; height: 40px; text-align: center; font-weight: bold; font-size: 1.3rem; z-index: 50; }
        .win-text { color: #2ecc71; text-shadow: 0 0 10px black; animation: pulse 0.5s infinite alternate; }
        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.1); } }

        .spin-btn-container { margin-top: 20px; display: flex; gap: 15px; }
        .btn-spin {
            background: linear-gradient(to bottom, #e74c3c, #c0392b); color: white;
            padding: 12px 50px; font-size: 1.5rem; border-radius: 50px; border: none;
            cursor: pointer; box-shadow: 0 5px 0 #922b21; transition: 0.1s; font-weight: bold;
        }
        .btn-spin:active { transform: translateY(4px); box-shadow: none; }
        .btn-spin:disabled { background: #555; box-shadow: none; cursor: not-allowed; }
        .btn-clear { background: #7f8c8d; border: none; padding: 10px 20px; border-radius: 50px; color: white; cursor: pointer; font-weight: bold; }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 200;
            display: none; align-items: center; justify-content: center;
        }
        .modal {
            background: #2c3e50; padding: 30px; border-radius: 15px; text-align: center;
            border: 2px solid var(--gold); box-shadow: 0 0 30px rgba(241, 196, 15, 0.3);
            animation: popIn 0.4s;
        }
        .modal h2 { color: var(--gold); margin-top: 0; }
        .btn-rescue {
            background: #27ae60; color: white; padding: 15px 30px; font-size: 1.2rem;
            border: none; border-radius: 10px; cursor: pointer; font-weight: bold; margin-top: 20px;
            box-shadow: 0 5px 0 #1e8449;
        }
        .btn-rescue:active { transform: translateY(5px); box-shadow: none; }

    </style>
</head>
<body>

    <canvas id="confetti-canvas"></canvas>

    <div class="modal-overlay" id="bankruptModal">
        <div class="modal">
            <h2>× ×’××¨ ×œ×š ×”×›×¡×£! ğŸ˜±</h2>
            <p>××œ ×“××’×”, ×”×‘×™×ª ××–××™×Ÿ ××•×ª×š ×œ×”××©×™×š ×œ×©×—×§.</p>
            <button class="btn-rescue" onclick="rescueFunds()">×§×‘×œ 500$ ××ª× ×” ğŸ’°</button>
        </div>
    </div>

    <h1>ROYAL ISRAEL CASINO</h1>

    <div class="main-layout">
        
        <div class="left-panel">
            <div class="stats-card">
                <div class="stats-title">××¡×¤×¨×™× ×—××™× ğŸ”¥</div>
                <div class="hot-row" id="hotList">
                    <span style="font-size: 0.8rem; color:#666;">××™×Ÿ × ×ª×•× ×™× ×¢×“×™×™×Ÿ</span>
                </div>
            </div>
            <div class="stats-card">
                <div class="stats-title">××¡×¤×¨×™× ×§×¨×™× â„ï¸</div>
                <div class="cold-row" id="coldList">
                    <span style="font-size: 0.8rem; color:#666;">××™×Ÿ × ×ª×•× ×™× ×¢×“×™×™×Ÿ</span>
                </div>
            </div>
        </div>

        <div class="center-panel">
            
            <div class="history-bar" id="historyBar">
                <span style="color: #aaa; margin-left: 10px; font-size: 0.9rem;">×”×™×¡×˜×•×¨×™×”:</span>
            </div>

            <div class="dashboard">
                <div class="stat-box">
                    <div class="stat-label">×§×•×¤×”</div>
                    <div class="stat-value val-balance" id="balanceDisplay">--.--$</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">×”×™××•×¨ × ×•×›×—×™</div>
                    <div class="stat-value" id="currentBetDisplay">0.00$</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">×¨×•×•×—×™×</div>
                    <div class="stat-value val-won" id="totalWonDisplay">0.00$</div>
                </div>
            </div>

            <div class="actions-row">
                <div class="pro-controls">
                    <div class="pro-btn" onclick="undoBet()" title="×‘×˜×œ ×¤×¢×•×œ×” ××—×¨×•× ×”"><span>â†©ï¸</span><small>×‘×˜×œ</small></div>
                    <div class="pro-btn" onclick="doubleBet()" title="×”×›×¤×œ ×”×›×œ"><span>âœ–ï¸2</span><small>×”×›×¤×œ</small></div>
                    <div class="pro-btn" onclick="rebet()" title="×—×–×•×¨ ×¢×œ ×”×™××•×¨ ×§×•×“×"><span>ğŸ”„</span><small>×—×–×•×¨</small></div>
                    <div class="pro-btn" onclick="betNeighbors()" title="×”××¨ ×¢×œ ×©×›× ×™× ×©×œ ×”××¡×¤×¨ ×”××—×¨×•×Ÿ"><span>ğŸ˜ï¸</span><small>×©×›× ×™×</small></div>
                </div>

                <div class="chip-selector">
                    <div class="chip-btn chip-0-5" onclick="selectChip(0.5)">0.5</div>
                    <div class="chip-btn chip-1 active" onclick="selectChip(1)">1</div>
                    <div class="chip-btn chip-2-5" onclick="selectChip(2.5)">2.5</div>
                    <div class="chip-btn chip-5" onclick="selectChip(5)">5</div>
                    <div class="chip-btn chip-10" onclick="selectChip(10)">10</div>
                </div>
            </div>

            <div class="game-container">
                <div class="marker"></div>
                <div class="wheel" id="wheel"></div>
                <div class="center-hub"></div>
                <div class="ball-container" id="ballContainer"><div class="ball"></div></div>
            </div>

            <div class="message" id="messageBox">×‘×—×¨ ×–'×™×˜×•×Ÿ ×•×”× ×— ×¢×œ ×”×©×•×œ×—×Ÿ</div>

            <div class="table-wrapper">
                <div class="betting-table" id="bettingTable">
                    <div class="b-cell bg-green cell-zero" data-bet="0" onclick="placeBet('0')">0</div>
                    <div class="b-cell bg-none col-bet" style="grid-row: 1" data-bet="col3" onclick="placeBet('col3')">2 to 1</div>
                    <div class="b-cell bg-none col-bet" style="grid-row: 2" data-bet="col2" onclick="placeBet('col2')">2 to 1</div>
                    <div class="b-cell bg-none col-bet" style="grid-row: 3" data-bet="col1" onclick="placeBet('col1')">2 to 1</div>
                    <div class="b-cell bg-none dozen-bet dozen-1" data-bet="1st12" onclick="placeBet('1st12')">1st 12</div>
                    <div class="b-cell bg-none dozen-bet dozen-2" data-bet="2nd12" onclick="placeBet('2nd12')">2nd 12</div>
                    <div class="b-cell bg-none dozen-bet dozen-3" data-bet="3rd12" onclick="placeBet('3rd12')">3rd 12</div>
                    <div class="b-cell bg-none outside-bet ob-1-18" data-bet="1-18" onclick="placeBet('1-18')">1-18</div>
                    <div class="b-cell bg-none outside-bet ob-even" data-bet="even" onclick="placeBet('even')">ZUGI</div>
                    <div class="b-cell bg-red outside-bet ob-red" data-bet="red" onclick="placeBet('red')">RED</div>
                    <div class="b-cell bg-black outside-bet ob-black" data-bet="black" onclick="placeBet('black')">BLACK</div>
                    <div class="b-cell bg-none outside-bet ob-odd" data-bet="odd" onclick="placeBet('odd')">I-ZUGI</div>
                    <div class="b-cell bg-none outside-bet ob-19-36" data-bet="19-36" onclick="placeBet('19-36')">19-36</div>
                </div>
            </div>

            <div class="spin-btn-container">
                <button class="btn-clear" onclick="clearBets()" id="clearBtn">× ×§×” ×”×›×œ</button>
                <button class="btn-spin" onclick="spin()" id="spinBtn">×¡×•×‘×‘ ××ª ×”×’×œ×’×œ!</button>
            </div>
        </div>
    </div>

    <script>
        /* --- Confetti Logic --- */
        const canvas = document.getElementById('confetti-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        let confetti = [];
        const confettiColors = ['#f1c40f', '#e74c3c', '#2ecc71', '#3498db', '#9b59b6'];

        function createConfetti() {
            for (let i = 0; i < 200; i++) {
                confetti.push({
                    x: Math.random() * canvas.width, y: Math.random() * canvas.height - canvas.height,
                    color: confettiColors[Math.floor(Math.random() * confettiColors.length)],
                    size: Math.random() * 8 + 4, speedY: Math.random() * 5 + 3,
                    speedX: Math.random() * 4 - 2, rotation: Math.random() * 360
                });
            }
            animateConfetti();
        }

        function animateConfetti() {
            if (confetti.length === 0) { ctx.clearRect(0,0,canvas.width,canvas.height); return; }
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            confetti.forEach((p, index) => {
                p.y += p.speedY; p.x += p.speedX; p.rotation += 5;
                ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.rotation * Math.PI / 180);
                ctx.fillStyle = p.color; ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size); ctx.restore();
                if (p.y > canvas.height) confetti.splice(index, 1);
            });
            requestAnimationFrame(animateConfetti);
        }

        /* --- Audio Synth --- */
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function beep(freq = 600, duration = 100, type='sine') {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.frequency.value = freq; osc.type = type;
            gain.gain.value = 0.1;
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); setTimeout(() => osc.stop(), duration);
        }

        /* --- Game Data --- */
        const wheelNumbers = [0, 32, 15, 19, 4, 21, 2, 25, 17, 34, 6, 27, 13, 36, 11, 30, 8, 23, 10, 5, 24, 16, 33, 1, 20, 14, 31, 9, 22, 18, 29, 7, 28, 12, 35, 3, 26];
        const redNumbers = [1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36];
        
        let balance = parseFloat(localStorage.getItem('roulette_balance')) || 1000.00;
        let numFrequencies = JSON.parse(localStorage.getItem('roulette_freq')) || Array(37).fill(0);
        let historyResults = [];
        
        let bets = {}; 
        let currentTotalBet = 0.00;
        let actionStack = [];
        let lastRoundBets = {};

        let selectedChipValue = 1;
        let isSpinning = false;
        let currentWheelRotation = 0; 
        let currentBallRotation = 0;

        /* --- Initialization --- */
        const wheel = document.getElementById('wheel');
        const bettingTable = document.getElementById('bettingTable');
        
        function init() {
            buildWheel();
            buildTableNumbers();
            updateUI();
            updateStatsDisplay();
            checkBankrupt();
        }

        function getColor(num) {
            if (num === 0) return 'green';
            return redNumbers.includes(num) ? 'red' : 'black';
        }

        function buildWheel() {
            const segmentAngle = 360 / wheelNumbers.length; 
            let gradientStr = '';
            wheelNumbers.forEach((num, index) => {
                const color = getColor(num);
                const hex = (color === 'green') ? '#27ae60' : (color === 'red' ? '#c0392b' : '#111');
                const start = index * segmentAngle;
                const end = (index + 1) * segmentAngle;
                gradientStr += `${hex} ${start}deg ${end}deg,`;
                
                const numDiv = document.createElement('div');
                numDiv.style.position = 'absolute'; numDiv.style.top = '0'; numDiv.style.left = '50%';
                numDiv.style.height = '50%'; numDiv.style.width = '20px';
                numDiv.style.transformOrigin = 'bottom center';
                numDiv.style.transform = `translateX(-50%) rotate(${start + segmentAngle/2}deg)`;
                
                const span = document.createElement('span');
                span.innerText = num; span.style.color = 'white'; span.style.fontSize = '12px'; span.style.fontWeight = 'bold';
                span.style.marginTop = '8px'; span.style.display = 'block';
                numDiv.appendChild(span); wheel.appendChild(numDiv);
            });
            wheel.style.background = `conic-gradient(${gradientStr.slice(0, -1)})`;
        }

        function buildTableNumbers() {
            for (let col = 1; col <= 12; col++) {
                let topNum = col * 3; createNumCell(topNum, col + 1, 1);
                let midNum = col * 3 - 1; createNumCell(midNum, col + 1, 2);
                let botNum = col * 3 - 2; createNumCell(botNum, col + 1, 3);
            }
        }

        function createNumCell(num, c, r) {
            const cell = document.createElement('div');
            const colorClass = redNumbers.includes(num) ? 'bg-red' : 'bg-black';
            cell.className = `b-cell ${colorClass}`;
            cell.innerText = num;
            cell.style.gridColumn = c; cell.style.gridRow = r;
            cell.dataset.bet = num.toString();
            cell.onclick = () => placeBet(num.toString());
            bettingTable.appendChild(cell);
        }

        /* --- Betting Logic --- */
        function selectChip(val) {
            beep(800, 30);
            selectedChipValue = val;
            document.querySelectorAll('.chip-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseFloat(btn.innerText) === val) btn.classList.add('active');
            });
        }

        function placeBet(type, customAmount = null) {
            if (isSpinning) return;
            const amount = customAmount || selectedChipValue;
            
            if (currentTotalBet + amount > balance + 0.001) {
                alert("××™×Ÿ ××¡×¤×™×§ ×›×¡×£ ×‘×§×•×¤×”!"); return;
            }

            if (!customAmount) beep(400, 30); // sound only for manual clicks
            
            currentTotalBet += amount;
            if (!bets[type]) bets[type] = 0;
            bets[type] += amount;
            
            actionStack.push({ type: type, amount: amount });
            updateUI(); renderChips();
        }

        /* --- Special Features --- */
        function betNeighbors() {
            // Bet on the last winning number and its neighbors
            if (historyResults.length === 0) {
                alert("××™×Ÿ ×”×™×¡×˜×•×¨×™×” ×¢×“×™×™×Ÿ. ×¡×•×‘×‘ ×¤×¢× ××—×ª ×›×“×™ ×œ×”×©×ª××© ×‘×–×”."); return;
            }
            const lastNum = historyResults[0];
            const idx = wheelNumbers.indexOf(lastNum);
            
            // Logic for neighbors (loop around array)
            const prevIdx = (idx - 1 + wheelNumbers.length) % wheelNumbers.length;
            const nextIdx = (idx + 1) % wheelNumbers.length;
            
            const neighbors = [wheelNumbers[prevIdx], lastNum, wheelNumbers[nextIdx]];
            
            // Place bets
            neighbors.forEach(n => placeBet(n.toString(), selectedChipValue));
            beep(600, 100);
        }

        function checkBankrupt() {
            if (balance < 10 && currentTotalBet === 0 && !isSpinning) {
                document.getElementById('bankruptModal').style.display = 'flex';
                beep(200, 300, 'sawtooth');
            }
        }

        function rescueFunds() {
            balance += 500;
            localStorage.setItem('roulette_balance', balance.toFixed(2));
            document.getElementById('bankruptModal').style.display = 'none';
            updateUI();
            beep(1000, 100); beep(1200, 100);
            createConfetti();
        }

        function updateStatsDisplay() {
            // Create array of objects {num, count}
            let freqArr = numFrequencies.map((count, num) => ({ num, count }));
            // Sort Descending
            freqArr.sort((a, b) => b.count - a.count);
            
            const hotDiv = document.getElementById('hotList');
            const coldDiv = document.getElementById('coldList');
            
            // Top 3 Hot
            let hotHTML = '';
            for(let i=0; i<3; i++) {
                if(freqArr[i].count > 0) {
                    const n = freqArr[i].num;
                    const color = getColor(n) === 'red' ? '#c0392b' : (getColor(n)==='black'?'#2c3e50':'#27ae60');
                    hotHTML += `<div class="stat-num-circle" style="background:${color}">${n}</div>`;
                }
            }
            hotDiv.innerHTML = hotHTML || '<span style="color:#666; font-size:0.8rem">××™×Ÿ × ×ª×•× ×™×</span>';

            // Top 3 Cold (Filter those with 0 or low count, taking from end of sorted array)
            let coldHTML = '';
            // We look at the end of the array. If game is new, all are 0.
            // Show indexes from end
            for(let i=freqArr.length-1; i >= freqArr.length-3; i--) {
                const n = freqArr[i].num;
                // Only show if we actually have some data in the game (sum of counts > 5) to make sense
                const totalSpins = numFrequencies.reduce((a,b)=>a+b,0);
                if (totalSpins > 0) {
                    const color = getColor(n) === 'red' ? '#c0392b' : (getColor(n)==='black'?'#2c3e50':'#27ae60');
                    coldHTML += `<div class="stat-num-circle" style="background:${color}">${n}</div>`;
                }
            }
            coldDiv.innerHTML = coldHTML || '<span style="color:#666; font-size:0.8rem">××™×Ÿ × ×ª×•× ×™×</span>';
        }

        /* --- Standard Controls --- */
        function undoBet() {
            if (isSpinning || actionStack.length === 0) return;
            const last = actionStack.pop();
            currentTotalBet -= last.amount;
            bets[last.type] -= last.amount;
            if (bets[last.type] <= 0.001) delete bets[last.type];
            beep(300, 50); updateUI(); renderChips();
        }

        function doubleBet() {
            if (isSpinning || currentTotalBet === 0) return;
            if (currentTotalBet * 2 > balance + 0.001) { alert("××™×Ÿ ××¡×¤×™×§ ×›×¡×£ ×œ×”×›×¤×™×œ"); return; }
            for (const [t, a] of Object.entries(bets)) {
                bets[t] += a;
                actionStack.push({ type: t, amount: a });
            }
            currentTotalBet *= 2; beep(600, 50); updateUI(); renderChips();
        }

        function rebet() {
            if (isSpinning || Object.keys(lastRoundBets).length === 0) return;
            clearBets();
            let total = 0;
            for (const amt of Object.values(lastRoundBets)) total += amt;
            if (total > balance) { alert("××™×Ÿ ××¡×¤×™×§ ×›×¡×£ ×œ-Rebet"); return; }
            
            bets = { ...lastRoundBets };
            currentTotalBet = total;
            // Fake stack for undo consistency
            actionStack = [];
            for (const [t, a] of Object.entries(bets)) actionStack.push({type:t, amount:a});
            
            updateUI(); renderChips(); beep(600, 50);
        }

        function clearBets() {
            if (isSpinning) return;
            currentTotalBet = 0; bets = {}; actionStack = [];
            updateUI(); renderChips();
        }

        function renderChips() {
            document.querySelectorAll('.chip-on-board').forEach(el => el.remove());
            for (const [key, amount] of Object.entries(bets)) {
                if (amount > 0) {
                    const cell = document.querySelector(`[data-bet="${key}"]`);
                    if (cell) {
                        const chip = document.createElement('div');
                        chip.className = 'chip-on-board';
                        chip.innerText = amount % 1 === 0 ? amount : amount.toFixed(1);
                        // Add height effect for larger stacks
                        if (amount >= 50) chip.style.boxShadow = "0 6px 5px rgba(0,0,0,0.6), inset 0 0 5px rgba(255,255,255,0.5)";
                        cell.appendChild(chip);
                    }
                }
            }
        }

        function updateUI() {
            const displayBal = balance - currentTotalBet;
            document.getElementById('balanceDisplay').innerText = displayBal.toFixed(2) + "$";
            document.getElementById('currentBetDisplay').innerText = currentTotalBet.toFixed(2) + "$";
            localStorage.setItem('roulette_balance', balance.toFixed(2));
        }

        /* --- Spin Logic --- */
        function spin() {
            if (currentTotalBet === 0) {
                const msg = document.getElementById('messageBox');
                msg.innerText = "×©×™× ×”×™××•×¨!"; msg.style.color = "orange"; return;
            }
            
            lastRoundBets = { ...bets };
            balance -= currentTotalBet;
            
            isSpinning = true;
            document.getElementById('spinBtn').disabled = true;
            document.getElementById('clearBtn').disabled = true;
            document.getElementById('messageBox').innerText = "×‘×”×¦×œ×—×”...";
            document.getElementById('messageBox').style.color = "white";

            const winningIndex = Math.floor(Math.random() * wheelNumbers.length);
            const winningNum = wheelNumbers[winningIndex];

            // Animation Math
            const segmentAngle = 360 / wheelNumbers.length;
            const numAngle = (winningIndex * segmentAngle) + (segmentAngle / 2);
            const spins = 5; 
            const cycle = Math.floor(currentWheelRotation / 360) * 360;
            let target = cycle - (spins * 360) - numAngle;
            if (target > currentWheelRotation) target -= 360 * spins;
            
            const ballSpins = 3;
            let ballTarget = Math.ceil((currentBallRotation + (360 * ballSpins))/360)*360;

            wheel.style.transform = `rotate(${target}deg)`;
            document.getElementById('ballContainer').style.transform = `rotate(${ballTarget}deg)`;

            currentWheelRotation = target;
            currentBallRotation = ballTarget;

            setTimeout(() => {
                isSpinning = false;
                document.getElementById('spinBtn').disabled = false;
                document.getElementById('clearBtn').disabled = false;
                resolveBet(winningNum);
            }, 4000);
        }

        function resolveBet(num) {
            let win = 0;
            const color = getColor(num);

            // Update Frequencies
            numFrequencies[num]++;
            localStorage.setItem('roulette_freq', JSON.stringify(numFrequencies));
            updateStatsDisplay();

            // Update History
            historyResults.unshift(num);
            if (historyResults.length > 10) historyResults.pop();
            
            // Render History
            const histBar = document.getElementById('historyBar');
            while(histBar.children.length > 1) histBar.removeChild(histBar.lastChild);
            historyResults.forEach(n => {
                const b = document.createElement('div'); b.className = 'hist-bubble';
                const c = getColor(n);
                b.innerText = n;
                b.style.backgroundColor = c==='red'?'#c0392b':(c==='black'?'#2c3e50':'#27ae60');
                histBar.appendChild(b);
            });

            // Calculate Win
            for (const [type, amt] of Object.entries(bets)) {
                let mult = 0;
                if (type === num.toString()) mult = 36;
                else if (type === 'red' && color === 'red') mult = 2;
                else if (type === 'black' && color === 'black') mult = 2;
                else if (num !== 0) {
                    if (type === 'even' && num%2===0) mult = 2;
                    if (type === 'odd' && num%2!==0) mult = 2;
                    if (type === '1-18' && num<=18) mult = 2;
                    if (type === '19-36' && num>=19) mult = 2;
                    if (type === '1st12' && num<=12) mult = 3;
                    if (type === '2nd12' && num>12 && num<=24) mult = 3;
                    if (type === '3rd12' && num>24) mult = 3;
                    if (type === 'col3' && num%3===0) mult = 3;
                    if (type === 'col2' && num%3===2) mult = 3;
                    if (type === 'col1' && num%3===1) mult = 3;
                }
                if (mult > 0) win += amt * mult;
            }

            balance += win;
            if (win > 0) {
                const totalWonEl = document.getElementById('totalWonDisplay');
                // Parse current displayed won, add new win
                let currentWon = parseFloat(totalWonEl.innerText);
                totalWonEl.innerText = (currentWon + win).toFixed(2) + "$";
            }

            currentTotalBet = 0; bets = {}; actionStack = [];
            renderChips(); updateUI();
            
            const msgBox = document.getElementById('messageBox');
            let msg = `×”××¡×¤×¨: ${num}`;
            msg += color==='red' ? " (××“×•×)" : (color==='black'?" (×©×—×•×¨)":" (×™×¨×•×§)");
            
            if (win > 0) {
                msgBox.innerHTML = `${msg}<br><span class="win-text">×–×›×™×ª ×‘-${win.toFixed(2)}$!</span>`;
                beep(600, 100); setTimeout(()=>beep(800,200),150);
                createConfetti();
            } else {
                msgBox.innerHTML = `${msg}<br><span style="color:#e74c3c">×œ× ×–×›×™×ª ×”×¤×¢×</span>`;
            }

            checkBankrupt();
        }

        // Init Game
        init();
        window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });

    </script>
</body>
</html>
